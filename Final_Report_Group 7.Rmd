---
title: "MA 679 Final Report"
author: "Group 7"
date: "2021/5/4"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library("readxl")
library("dplyr")
library("caret")
library("purrr")
library("randomForest")
library("e1071")
library("pROC")
#Data import
data <- read_excel("Health Literacy Transformed Data.xlsx", 
           sheet = "Transformed")

guide <- read_excel("NCCN Guidelines.xlsx")
```

# Introduction

For doctors we met with are interested in bias contained in SEER data, so after have some initial exploration of SEER data, we decided to see whether there is bias between doctor's decision and the treatment guideline. The treatment guideline is based on TNM cancer stage, we only have information about AJCC cancer stage, which means we cannot match all cancer type with their guidelines. Therefore, we only chose  cancer on Salivary Grand to do further exploration since its treatment matches well with the data.

# Data Processing

In the data processing step, we first select all the Salivary Grand cancer. Since we cannot find treatment with stage 'IVC' and 'IVNOS', and they are minor so we remove them as well. Based on the `NCCN Guidelines`, we found that only stage 'IVB' has different treatment 1 for others are recommended to have surgery while it not. Depending on that, we create a column with information whether they followed the treatment guideline or not, and '0' means they did not followed, '1' means they followed. Meanwhile, we replace all the blank space and symbols in column names for convenience.

Also we created some new variables:

Because we decided to use machine learning, we also separate the data into training data and test data, and guarantee that the proportion of 0 and 1 response in both two samples are similar.

```{r}
sali <- data %>% filter(Site == "Salivary Gland")

sali <- sali %>% filter(`AJCC 7 Stage` != "IVC" & `AJCC 7 Stage` != "IVNOS")

sali$follow <- 0

saliB <- sali %>% filter(`AJCC 7 Stage` != "IVB")
unique(saliB$`Surgery Decision`)

for(i in 1:nrow(sali)){
  if (sali[i,]$`AJCC 7 Stage` != "IVB"){
     if(sali[i,]$`Surgery Decision` != "Not recommended"){
       sali[i,]$follow = 1
     }
  } else{
    if(sali[i,]$`Surgery Decision` == "Not recommended" | sali[i,]$`Surgery Decision` == "Not recommended, contraindicated due to              other cond; autopsy only (1973-2002)") {
      sali[i,]$follow == 1
    }
  }
}



sali$Race2 <- ifelse(sali$Race == "White", "White", "Other")
```
```{r}
names(sali) <- gsub("\\s+", "_", names(sali))
names(sali) <- gsub("%_<", "Pct_Less_", names(sali))
names(sali) <- gsub("%_", "Pct_", names(sali))
names(sali) <- gsub("-", "_", names(sali))
names(sali) <- gsub("\\(|)", "", names(sali))
names(sali) <- gsub("\\?", "", names(sali))
```

```{r}
#surgery decision, performed, radiation,  chemo, Mets, subsite, ID.
trainsali <- sali[,-c(1,15,16,20:25)]
trainsali$follow <- as.factor(trainsali$follow)
trainsali$Sex <- as.factor(trainsali$Sex)
trainsali$Year_of_Diagnosis <- as.factor(trainsali$Year_of_Diagnosis)
trainsali$Race <- as.factor(trainsali$Race)
trainsali$Insurance <- as.factor(trainsali$Insurance)
trainsali$AJCC_7_Stage <- as.factor(trainsali$AJCC_7_Stage )
trainsali$SEER_Registry <- as.factor(trainsali$SEER_Registry)

set.seed(123)
getColUni <- function(x){
  length(unique(x))
} 
getSample <- function(data){
  repeat{
    sample <-createDataPartition(y=data$follow,p=0.7,list=FALSE)
    train <- data[sample, ] 
    # length(train$follow)-sum(train$follow==1)
    # test <- data[-sample, ]
    # length(test$follow)-sum(test$follow==1)
    dataCat <- select_if(data,negate(is.numeric))
    trainCat <- select_if(train,negate(is.numeric))
    if(all(rapply(dataCat, getColUni)[-c(1,ncol(dataCat))]== rapply(trainCat, getColUni)[-c(1,ncol(trainCat))])) break
  }
  return(sample)
}

sample <- getSample(trainsali)

train <- trainsali[sample,]
test <- trainsali[-sample,]
```

# EDA

# Modeling

## Random Forest